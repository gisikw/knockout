---
id: ko-c569
status: open
deps: []
links: []
created: 2026-02-17T02:13:55Z
type: task
priority: 2
---
# Agent adapter system â€” configurable CLI harness for multi-agent support (claude, cursor, codex, opencode)

## Problem

`ko build` currently hardcodes Claude Code assumptions: prompt via stdin,
`-p --output-format text`, `--model`, `--append-system-prompt`. Other agent
CLIs (Cursor's `agent`, Codex, OpenCode) have different flag names, different
prompt delivery methods (arg vs stdin), and different permission models.

## Design

Replace the `command:` string in pipeline.yml with an `agent:` key that
selects a built-in adapter, plus a small set of behavioral flags:

```yaml
agent: claude          # claude | cursor | codex | opencode
allow_all_tool_calls: false  # maps to --dangerously-skip-permissions, --force, etc.
model: claude-sonnet-4-5-20250929
```

Each adapter is a Go struct that knows:
- Binary name and static flags
- How to deliver the prompt (stdin vs CLI arg)
- How to pass model selection (flag name, or inline if unsupported)
- How to pass system prompt (flag name, or inline into prompt if unsupported)
- What the "allow all" flag is (if any)

### Adapter interface

```go
type AgentAdapter interface {
    BuildCommand(prompt, model, systemPrompt string, allowAll bool) *exec.Cmd
}
```

Each adapter implements this. `runPromptNode` calls `adapter.BuildCommand()`
instead of constructing args directly.

### Built-in adapters

**claude:**
- Binary: `claude`
- Prompt: stdin
- Flags: `-p --output-format text`
- Model: `--model <model>`
- System prompt: `--append-system-prompt <text>`
- Allow all: `--dangerously-skip-permissions`

**cursor:**
- Binary: `agent`
- Prompt: CLI arg after `-p`
- Flags: `-p --output-format text`
- Model: not supported (skip)
- System prompt: inline into prompt
- Allow all: `--force`

**codex / opencode:** Stub adapters, fill in when we know their CLI contracts.

### Migration

- `command:` key continues to work as a raw override (backwards compat)
- If both `agent:` and `command:` are set, error
- Default remains `claude` if neither is specified

## Acceptance Criteria

- [ ] `agent: claude` works identically to current behavior
- [ ] `agent: cursor` invokes `agent` binary with correct flags and arg-based prompt
- [ ] `allow_all_tool_calls: true` maps to the correct flag per adapter
- [ ] Model and system prompt are handled per adapter (flag or inline fallback)
- [ ] `command:` still works as raw override for unknown CLIs
- [ ] Adapters are easy to add (just implement the interface)
